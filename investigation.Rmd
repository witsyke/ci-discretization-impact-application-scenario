---
title: "Investigation of Causal Effects"
author: "Daniel Lindner, Simon Witzke"
date: "6/30/2020"
output: pdf_document
---

```{r setup, include=FALSE}
library(xtable)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=62), tidy=TRUE, message = FALSE, warning = FALSE)
source("./helper.R")
load("./nets/mehra-complete.rda")

# define sample size
sample.size <- 10000

# gather observations from original net
sim.data <- rbn(bn, sample.size)
sim.data$Year <- as.numeric(as.character(sim.data$Year))


test.data <- sim.data %>%
  base::sapply(function(x) if(!is.factor(x)){factor(Ckmedian.1d.dp(x, k=c(2,2))$cluster)} else x) %>%
  base::as.data.frame()



test.data2 <- discretize(sim.data, breaks=3)
```

## Translation of learned bayesian network to igraph

```{r warning = FALSE}
#sample.size <- 5000000
#sample <- generate.sample(sample.size)

#clustered.data <- sample %>%
# base::sapply(function(x) if(!is.factor(x)){factor(Ckmedian.1d.dp(x, k=c(3,5))$cluster)} else x) %>%
#base::as.data.frame()

# TODO replace bn with our learned and saved model
adj.matrix.from.bngraph <- amat(bn)
igraph.from.bnmatrix<- graph_from_adjacency_matrix(adj.matrix.from.bngraph)
# TODO mark undirected edges as such

```

## Plot network

```{r pressure, echo=FALSE}
graphviz.plot(bn)
```


## Find causal effect
```{r }
effect.igraph.from.bnmatrix <- causal.effect(y = "so2", x = "co", z = NULL, G = igraph.from.bnmatrix, expr = T)
```

$`
```{r echo=FALSE, results="asis"}
cat(effect.igraph.from.bnmatrix)
```
`$

## Estimate causal effect strength

```{r results='asis'}
causal.effect.probabilites.so2.co <- function(data) {
  # select relevant columns
  data <- data %>%
    select(so2, co, Type, Zone, Year) 
  
  # calculate probabilities for realisations of Zone 
  data <- data %>%
    add_count(Zone) %>%
    mutate(prob_zone = n / n()) %>%
    select(-n) 
  
  # calculate probabilities for realisations of Type 
  data <- data %>%
    add_count(Type) %>%
    mutate(prob_type = n / n()) %>%
    select(-n) 
  
  # calculate probabilities for realisations of Year 
  data <- data %>%
    add_count(Year) %>%
    mutate(prob_datetime = n / n()) %>%
    select(-n) 
  
  # calculate conditional probability for so2 by Zone, Type, Year, co
  data <- data %>%
    group_by(Zone, Type, Year, co) %>%
    add_count(so2) %>%
    group_by(Zone, Type, Year, co) %>%
    mutate(so2_cond_prob = n / n()) %>%
    select(-n) 
  
  # calculate causal effect and add probability for co to table
  data <- data %>%
    ungroup() %>%
    distinct() %>%
    mutate(total_prob = prob_zone * prob_type * prob_datetime * so2_cond_prob) %>%
    group_by(so2, co) %>%
    summarise(P_so2 = sum(total_prob)) %>%
    inner_join(data %>%
                 group_by(co) %>%
                 count(co) %>%
                 mutate(P_co = n / nrow(data)) %>%
                 select(-n))
  
  
}
# calculates the conditional mutual information for do(co) on so2
conditional.mutual.information.so2.co <- function(data) {
  causal.effects <- causal.effect.probabilites.so2.co(data)
  
  # Calculation of sum in denominator of logarithm
  log.sum <- function(vj){
    sum(causal.effects %>%
      filter(so2 == vj) %>%
      base::apply(MARGIN = 1, function(x)
      as.numeric(x["P_so2"]) * as.numeric(x["P_co"])))
  }
  
  # Rowwise calculation of Conditional Mutual Information
  sum(causal.effects %>%
        base::apply(MARGIN = 1, function(x)
          as.numeric(x["P_co"]) * as.numeric(x["P_so2"]) * log(as.numeric(x["P_so2"]) / log.sum(x["so2"]))))
}



#xtable(causal.effect.probabilites.so2.co(clustered.data), digits = c(0, 0, 0, 10, 5))
#causal.effect.size.so2.co(clustered.data)


xtable(causal.effect.probabilites.so2.co(test.data),
       digits = c(0, 0, 0, 10, 5))
# causal.effect.probabilites.so2.co(test.data)
cep <- causal.effect.probabilites.so2.co(test.data) %>% arrange(co)

cep %>%
  filter(so2 == 1) %>%
  ggplot(aes(x=co, y = P_co * 100, fill = co)) + geom_bar(stat='identity')

cep %>%
  filter(co == 1) %>%
  ggplot(aes(x=so2, y = P_so2_prior * 100, fill = so2)) + geom_bar(stat='identity')

cep %>%
  ggplot(aes(x=so2, y = P_so2 * 100, fill=co)) + geom_bar(stat='identity', position = position_dodge())

conditional.mutual.information.so2.co(test.data)
library(stringr)

test.data2 %>%
  select(so2) %>%
  distinct() %>%
  mutate(so2_range = as.numeric(str_extract(as.character(so2), "(?<=,)-?[0-9]+(?:.[0-9]+)?(e\\+[0-9]+)?")) -  as.numeric(str_extract(as.character(so2), "-?[0-9]+(?:.[0-9]+)?(e\\+[0-9]+)?"))) %>%
  mutate(so2_range_norm = scale(so2_range, center = FALSE, scale=TRUE)) %>%
  inner_join(test.data2 %>%
               count(so2)) %>%
  ggplot(aes(x=so2, y = n, fill = as.character(so2_range), width = so2_range_norm)) + geom_bar(stat='identity')

test.data2 %>%
  select(co) %>%
  distinct() %>%
  mutate(co_range = as.numeric(str_extract(as.character(co), "(?<=,)-?[0-9]+(?:.[0-9]+)?(e\\+[0-9]+)?")) -  as.numeric(str_extract(as.character(co), "-?[0-9]+(?:.[0-9]+)?(e\\+[0-9]+)?"))) %>%
  mutate(co_range_norm = scale(co_range, center = FALSE, scale=TRUE)) %>%
  inner_join(test.data2 %>%
               count(co)) %>%
  ggplot(aes(x=co, y = n, fill = as.character(co_range), width = co_range_norm)) + geom_bar(stat='identity')


ggplot(data.frame(sim.data$co), aes(sim.data$co)) + geom_histogram(bins = 20)

ggplot(data.frame(sim.data$co), aes(sim.data$co)) + geom_histogram(bins = 2)



ggplot(data.frame(sim.data$so2), aes(sim.data$so2)) + geom_histogram(bins = 20)

ggplot(data.frame(sim.data$so2), aes(sim.data$so2)) + geom_histogram(bins = 2)



```


```{r}

  f <- test.data %>%
    select(so2, co, Type, Zone, Year) %>%
    #select(so2, co, Type, Zone, DateTime) %>%
    add_count(Zone) %>%
    
    mutate(prob_zone = n / n()) %>%
    select(-n) %>%
    add_count(Type) %>%
    mutate(prob_type = n / n()) %>%
    select(-n) %>%
    #add_count(DateTime) %>%
    add_count(Year) %>%
    mutate(prob_datetime = n / n()) %>%
    select(-n) %>%
    #group_by(Zone, Type, DateTime, co) %>%
    group_by(Zone, Type, Year, co) %>%
    add_count(so2) %>%
    group_by(Zone, Type, Year, co) %>%
    mutate(count = n(),
      so2_cond_prob = n / n()) %>%
    ungroup() %>%
    distinct() %>%
    mutate(total_prob = prob_zone * prob_type * prob_datetime * so2_cond_prob) %>%
    arrange(Type, Zone, Year) 
  
    
    f3 <- test.data %>%
    select(Type, Zone, Year) %>%
    #select(so2, co, Type, Zone, DateTime) %>%
    add_count(Zone) %>%
    
    mutate(prob_zone = n / n()) %>%
    select(-n) %>%
    add_count(Type) %>%
    mutate(prob_type = n / n()) %>%
    select(-n) %>%
    #add_count(DateTime) %>%
    add_count(Year) %>%
    mutate(prob_datetime = n / n()) %>%
    select(-n) %>%
    tidyr::expand(Type, Zone, Year) %>%
      left_join(f %>% select(Type, prob_type) %>% distinct()) %>%
      left_join(f %>% select(Zone, prob_zone) %>% distinct()) %>%
      left_join(f %>% select(Year, prob_datetime) %>% distinct())

```

```{r}

loop.based.function <- function(data, co, so2){
  result <- 0
  for(type in unique(data$Type)){
    for(zone in unique(data$Zone)){
      for(year in unique(data$Year)){
        # print(paste(type, zone, year, sep = "-"))
        r <- sum(data$Type == type & data$Zone == zone & data$Year == year & data$co == co)
        temp = sum(data$Type == type)/ nrow(data) * 
          sum(data$Zone == zone)/ nrow(data) * 
          sum(data$Year == year)/ nrow(data) * 
          sum(data$Type == type & data$Zone == zone & data$Year == year & data$co == co & data$so2 == so2) / if_else(r == 0, 1L, r)
        # print(temp)
        result <- result + temp
      }
    }
  }
  result
}

loop.based.function (test.data, "2", "1")
loop.based.function (test.data, "2", "2")

loop.based.function (test.data, "1", "1")
loop.based.function (test.data, "1", "2")
```

```{r}
so2.2 <- test.data %>% filter(so2 == "2")	

so2.2 %>% select(so2, Type, Zone, Year) %>% distinct()
=
```